name: evolve  # nightly genetic evolution run

on:
  # run every night at 02:00 UTC
  schedule:
    - cron: "0 2 * * *"
  # allow manual trigger from Actions tab
  workflow_dispatch:

jobs:
  # ─────────────────────────────────────────
  # 1 ▸ spawn children and back-test them
  # ─────────────────────────────────────────
  children:
    runs-on: ubuntu-latest
    env:
      NUM_CHILDREN: 8            # ← tweak population size here
      QCCLI_PROJECT_ID: ${{ secrets.QC_PROJECT_ID }}
      QC_API_TOKEN:    ${{ secrets.QC_API_TOKEN }}
      GCP_SA_KEY:      ${{ secrets.GCP_SA_KEY }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with: {python-version: '3.10'}

      - name: Install deps
        run: pip install google-cloud-firestore requests

      - name: Spawn children algos
        run: python tools/algo_gen.py

      - name: Run back-tests
        run: python tools/evolve.py            # driver → QC back-tests -> backtest-results.json*

      - name: Upload back-test bundle
        uses: actions/upload-artifact@v4
        with:
          name: all-backtests
          path: backtest-results*.json

  # ─────────────────────────────────────────
  # 2 ▸ select best child → promote to parent
  # ─────────────────────────────────────────
  champion:
    needs: children          # wait until children job finishes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with: {python-version: '3.10'}

      - name: Install Firestore client
        run: pip install google-cloud-firestore

      - name: Pick champion & promote
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          python tools/select_champion.py
          echo "🏆 champion written → champion.json & parent_algo.json"

      - name: Upload champion artefacts
        uses: actions/upload-artifact@v4
        with:
          name: champion
          path: |
            champion.json
            parent_algo.json
