# .github/workflows/evolve.yml
name: evolve
on:
  workflow_dispatch:            # manual
  schedule:                     # every 10â€¯min
    - cron: '*/10 * * * *'
concurrency:
  group: evolve
  cancel-in-progress: true
env:
  NUM_CHILDREN: 5
  QC_PROJECT_ID: 23708106
  LEAN_CLI_VERSION: "2.5.0"
  LEAN_CLOUD_TIMEOUT: 1200      # sec
jobs:
  evolve:
    runs-on: ubuntu-latest
    steps:
      # ---- Step 0: checkout code -----------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # ---- Step 1: spawn N child strategies ------------------------------
      - name: Generate new child strategy
        run: |
          python algo_gen.py --num $NUM_CHILDREN
      # ---- Step 2: run QC cloud back-test --------------------------------
      - name: Run back-test in Lean Cloud
        run: |
          # Create a unique name for this backtest run
          BACKTEST_NAME="Evolve-Run-${{ github.run_number }}-${{ env.NUM_CHILDREN }}-Children-$(date +%F-%H%M)"
          echo "Starting backtest with name: $BACKTEST_NAME"

          lean cloud backtest "$QC_PROJECT_ID" \
               --name "$BACKTEST_NAME" \
               --timeout $LEAN_CLOUD_TIMEOUT \
               --output backtest-results.json
        env:
          LEAN_CLI_VERSION: ${{ env.LEAN_CLI_VERSION }}
          QC_PROJECT_ID:   ${{ env.QC_PROJECT_ID }}

      # ---- Step 3: (results already downloaded by previous step) ---------
      - name: Download results.json
        run: |
          echo "Results saved as backtest-results.json"
      # ---- Step 4: store results in Firestore ----------------------------
      - name: Store results in Firestore
        run: |
          python store_results.py
        env:
          BACKTEST_ID: ${{ github.run_id }}
          GCP_SA_KEY:  ${{ secrets.GCP_SA_KEY }}

      # ---- Step 5: evaluate vs champion ----------------------------------
      - name: Evaluate candidate
        run: |
          python select_winner.py
      # ---- Step 6: promote if better -------------------------------------
      - name: Promote new champion
        run: |
          python select_champion.py
