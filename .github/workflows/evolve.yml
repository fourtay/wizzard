# .github/workflows/evolve.yml
name: evolve

on:
  workflow_dispatch:          # run manually from GitHub UI
  schedule:                   # or every 10 minutes
    - cron: '*/10 * * * *'

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
env:                          # tweak these if you wish
  NUM_CHILDREN: "5"           # how many new algos per generation
  PROJECT_ID: "23708106"      # QuantConnect project GUID
  COLLECTION: "backtest_results"      # Firestore collection
  GOOGLE_APPLICATION_CREDENTIALS: gcp_key.json

jobs:
  evolve:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1 Checkout repo
      - uses: actions/checkout@v4

      # 2 Python
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3 Install deps
      - name: Install Python requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4 Write GCP service-account key to disk
      - name: Write GCP key
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}   # add this in repo ‚Üí Settings ‚Üí Secrets
        run: |
          echo "$GCP_SA_KEY" > gcp_key.json

      # 5 Generate new algos (‚Äúchildren‚Äù)
      - name: Generate children
        run: |
          python tools/algogen/algo_gen.py \
            --num_children "$NUM_CHILDREN"

      # 6 Iterate through children & run QC back-tests
      - name: Run back-tests in the cloud
        run: |
          for child in outputs/*.py; do
            echo "üì§  Testing $child"
            lean cloud backtest "$PROJECT_ID" --code "$child" \
              --output backtest-results.json
            python tools/algogen/store_results.py  # uploads the JSON
          done

      # 7 Pick the best-performing child (S6)
      - name: Select generation winner
        run: python tools/algogen/select_winner.py

      # 8 Evolve parameters for next generation
      - name: Evolve into next generation
        run: |
          python tools/algogen/evolve.py \
            --num_children "$NUM_CHILDREN" \
            --inherit_from firestore:evolve_state/parent
