# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ choose winners & spawn next gen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  select-and-spawn:
    needs: fanout-backtests     # wait until every child finished
    runs-on: ubuntu-latest
    env:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      GENERATION: ${{ needs.fanout-backtests.outputs.generation }}
      TOP_K: "2"
      METRIC: "sharpeRatio"
      NUM_CHILDREN: "5"
      QC_PROJECT_ID: "23708106"
      QC_API_TOKEN: ${{ secrets.QC_API_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps
        run: pip install google-cloud-firestore

      - name: Select winners
        id: winners
        run: |
          python wizard/select_winners.py
          echo "WIN_JSON<<EOF" >> $GITHUB_OUTPUT
          cat winners.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Spawn next generation
        run: |
          NEXT_GEN=$(python - <<'PY'
          import os, re, datetime as dt
          g = os.environ['GENERATION']
          num = int(re.search(r'gen(\d+)$', g).group(1)) + 1
          base = re.sub(r'gen\d+$', '', g)
          print(f"{base}gen{num:02d}")
          PY)

          echo "ðŸŒ±  Creating $NUM_CHILDREN children for $NEXT_GEN"
          for i in $(seq 1 $NUM_CHILDREN); do
            CHILD_BRANCH="${NEXT_GEN}-child${i}"
            git checkout -b "$CHILD_BRANCH"
            # â¬‡ï¸ here you'd call your param mutator script;
            # for now we just touch a dummy file so the branch is non-empty
            echo "$RANDOM" > wizard/seed_$i.txt
            git add wizard/seed_$i.txt
            git commit -m "seed for $CHILD_BRANCH"
            git push origin "$CHILD_BRANCH"
            git checkout -
          done

          # finally, fire the back-test dispatcher
          for i in $(seq 1 $NUM_CHILDREN); do
            BR="${NEXT_GEN}-child${i}"
            curl -X POST -H "Accept: application/vnd.github+json" \
                 -H "Authorization: Bearer ${{ github.token }}" \
                 https://api.github.com/repos/${{ github.repository }}/dispatches \
                 -d "{\"event_type\":\"backtest-branch\",\"client_payload\":{\"branch\":\"${BR}\"}}"
          done
