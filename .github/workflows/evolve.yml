# .github/workflows/evolve.yml
name: evolve

# ── When to run ────────────────────────────────────────────────────────────────
on:
  # every 30 min
  schedule:
    - cron: "*/30 * * * *"
  # manual button in the Actions tab
  workflow_dispatch:

jobs:
  evolve:
    runs-on: ubuntu-latest

    # ── Global env vars (tweak freely) ────────────────────────────────────────
    env:
      NUM_CHILDREN:   "5"                   # kids per generation
      NUM_SURVIVORS:  "2"                   # winners that become parents
      BACKTEST_COLLECTION: "backtest_results"

      # required secrets – already added in GitHub → Settings → Secrets
      QC_API_TOKEN:   ${{ secrets.QC_API_TOKEN }}
      GCP_SA_KEY:     ${{ secrets.GCP_SA_KEY }}

    # every run command is bash -e  (fail fast on errors)
    defaults:
      run:
        shell: bash -e {0}

    steps:
    # ── 0. checkout repo ──────────────────────────────────────────────────────
    - name: Checkout repo
      uses: actions/checkout@v3

    # ── 1. Python toolchain ───────────────────────────────────────────────────
    - name: Setup Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # ── 2. Generate fresh children (wizard/algo_gen.py) ───────────────────────
    - name: Generate children 🐣
      run: |
        python wizard/algo_gen.py --num "$NUM_CHILDREN"

    - name: Commit children 💾
      run: |
        git config user.name  "evolve-bot"
        git config user.email "evolve-bot@users.noreply.github.com"
        git add wizard/children/
        git commit -m "ci: add children for new generation [skip ci]" || echo "Nothing to commit"
        git push

    # ── 3. Kick off all back-tests in QuantConnect Cloud ──────────────────────
    - name: Launch back-tests 🚀
      run: |
        python wizard/run_backtests.py

    - name: Wait for back-tests ⏳
      run: |
        python wizard/wait_backtests.py

    # ── 4. Pick the best performers (new) ─────────────────────────────────────
    - name: Select survivors 📊
      run: |
        python wizard/select_survivors.py

    - name: Commit survivor list 🆕
      run: |
        git config user.name  "evolve-bot"
        git config user.email "evolve-bot@users.noreply.github.com"
        git add parents.txt
        git commit -m "ci: update parents.txt with survivors [skip ci]" || echo "Nothing new to commit"
        git push
