jobs:
  evolve:
    runs-on: ubuntu-latest

    steps:
    # 1 ▸  checkout & python
    - name: Check out source
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install requirements + Lean CLI
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install "lean==1.0.219"

    # 2 ▸  create a *fresh* Lean root for this run
    - name: Prepare Lean root
      run: |
        rm -rf qc_root             # start totally clean each run
        mkdir  qc_root
        cd     qc_root

        # fresh, non-interactive init bound to **your org**
        lean init \
          --organization-id "$QC_ORG_ID" \
          --yes

        # authenticate
        lean login --user-id "$QC_USER_ID" --api-token "$QC_API_TOKEN"

    # 3 ▸  run your helper scripts *inside* qc_root
    - name: Generate child algorithm
      run: |
        cd qc_root
        python ../algo_gen.py --num "$NUM_CHILDREN"

    - name: Run back-test
      run: |
        cd qc_root
        python ../run_backtest.py

    - name: Select best result
      env:
        GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GCP_SA_KEY }}
      run: |
        cd qc_root
        python ../select_winner.py
